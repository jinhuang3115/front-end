# javaScript (event loop)事件机制

javaScript是单线程，为了协调事件、用户交互、脚本、UI渲染以及网络处理等行为，浏览器必须使用事件机制来协调。
了解事件机制对性能优化和架构设计是非常重要的。

## 任务
任务有两种分类，一种是同步任务和异步任务，另外一种是宏任务和微任务。

* 同步任务: 立即执行的任务，会直接放入到可执行队列中。
* 异步任务: 需要异步执行的任务，会注册到异步任务队列中等待同步任务执行完后放入可执行队列中。
* 宏任务: script(执行脚本)、UI交互、计时器、setImmediate(把方法放入回调函数中，等完成其他操作后立即执行)、I/O。
* 微任务: process.nextTick(把方法放入微事件队列中)、promise、MutationObserver(监听dom节点变化)、Object.observe(监听对象变化).

## 事件循环

![](javaScript事件机制.png)

javaScript引擎一直在等待任务、执行任务和休眠中循环。当执行队列中有任务的时候就会去执行任务，
如果发现是异步任务就先把异步任务注册到异步任务队列中，当可执行队列中的同步任务全部执行完毕后异步任务按顺序进入到可执行队列中执行。
当全部任务都执行完毕进入休眠状态，知道可执行队列中有任务进来再执行任务，如此往复。

当浏览器在加载一个页面时，JavaScript首先会执行同步任务(可执行的脚本)。如果在执行的过程中发现setTimeout或者promise等就会把这些任务进行注册。
当时机到时会把执行脚本放入异步执行队列，如果是宏任务就放入宏任务队列，如果是微任务就放入微任务队列，比如当setTimeout时间到了，或者promise被触发，或者当用户点击了dom等。

### 宏任务和微任务
每一个宏任务在执行完毕后，事件机制会立即微任务队列中的任务然后再执行其他宏任务。

## 总结
由于事件机制的这一特性，可以发现一些有趣的事情。

### 例
`setTimeout(() => {console.log('aa')}, 1000);` console.log('aa') 会在1秒后放入
宏异步队列中而不是1秒后执行，如果前面没有同步任务或者没有其他宏任务和微任务排队才会在1秒后立即执行，否则就要排队执行，会超过1秒执行。

```javascript
setTimeout(() => console.log("aa"));
 
 Promise.resolve()
   .then(() => console.log("bb"));
 
 console.log("c");
```
在这个例子中首先会输出'c'因为这个是同步任务，然后会输出'bb'这个是微任务要优先于宏任务执行，最后输出'aa'。

另外，由于同步任务在执行中，是不会执行其他任务的比如点击事件。这样在就会出现如果页面出来后有大量的同步脚本再执行，同时用户点击页面按钮，
那么这个点击事件触发脚本就会等待所有的同步任务和排在前面的任务全部执行完毕后才会被执行。这样就需要去把大量的同步脚本拆分成多个任务穿插放入异步任务队列中排队，
这样就可以让其他异步任务插件来执行了。

了解javaScript事件机制可以更好地去做性能优化和架构优化。
